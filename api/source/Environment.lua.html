<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<head>
    <title>Reference</title>
    <link rel="stylesheet" href="../ldoc.css" type="text/css" />
</head>
<body>

<div id="container">

<div id="product">
	<div id="product_logo"></div>
	<div id="product_name"><big><b></b></big></div>
	<div id="product_description"></div>
</div> <!-- id="product" -->


<div id="main">


<!-- Menu -->

<div id="navigation">
<br/>
<h1>Lua driver for Exasol</h1>


<ul>
  <li><a href="../index.html">Index</a></li>
</ul>



<h2>Source</h2>
<ul class="nowrap">
  <li><a href="../source/exasol.lua.html">exasol.lua</a></li>
  <li><a href="../source/Connection.lua.html">Connection.lua</a></li>
  <li><a href="../source/ConnectionProperties.lua.html">ConnectionProperties.lua</a></li>
  <li><a href="../source/Cursor.lua.html">Cursor.lua</a></li>
  <li><a href="../source/CursorData.lua.html">CursorData.lua</a></li>
  <li><strong>Environment.lua</strong></li>
  <li><a href="../source/ExasolWebsocket.lua.html">ExasolWebsocket.lua</a></li>
  <li><a href="../source/Websocket.lua.html">Websocket.lua</a></li>
  <li><a href="../source/WebsocketDatahandler.lua.html">WebsocketDatahandler.lua</a></li>
  <li><a href="../source/constants.lua.html">constants.lua</a></li>
  <li><a href="../source/util.lua.html">util.lua</a></li>
  <li><a href="../source/examples.lua.html">examples.lua</a></li>
</ul>
<h2>Modules</h2>
<ul class="nowrap">
  <li><a href="../modules/luasql.exasol.html">luasql.exasol</a></li>
  <li><a href="../modules/luasql.exasol.constants.html">luasql.exasol.constants</a></li>
  <li><a href="../modules/luasql.exasol.util.html">luasql.exasol.util</a></li>
</ul>
<h2>Classes</h2>
<ul class="nowrap">
  <li><a href="../classes/luasql.exasol.Connection.html">luasql.exasol.Connection</a></li>
  <li><a href="../classes/luasql.exasol.ConnectionProperties.html">luasql.exasol.ConnectionProperties</a></li>
  <li><a href="../classes/luasql.exasol.Cursor.html">luasql.exasol.Cursor</a></li>
  <li><a href="../classes/luasql.exasol.CursorData.html">luasql.exasol.CursorData</a></li>
  <li><a href="../classes/luasql.exasol.Environment.html">luasql.exasol.Environment</a></li>
  <li><a href="../classes/luasql.exasol.ExasolWebsocket.html">luasql.exasol.ExasolWebsocket</a></li>
  <li><a href="../classes/luasql.exasol.Websocket.html">luasql.exasol.Websocket</a></li>
  <li><a href="../classes/luasql.exasol.WebsocketDatahandler.html">luasql.exasol.WebsocketDatahandler</a></li>
</ul>
<h2>Examples</h2>
<ul class="nowrap">
  <li><a href="../examples/examples.lua.html">examples.lua</a></li>
</ul>

</div>

<div id="content">

    <h2>Environment.lua</h2>
<pre>
<span class="comment">--- This class provides methods for connecting to an Exasol database and closing all connections.
</span><span class="comment">-- @classmod luasql.exasol.Environment
</span><span class="comment">-- @field private exasol_websocket ExasolWebsocket
</span><span class="comment">-- @field private connections table list of created connections
</span><span class="keyword">local</span> Environment = {}

<span class="comment">-- [impl-&gt;dsn~logging-with-remotelog~1]
</span><span class="keyword">local</span> log = <span class="global">require</span>(<span class="string">"remotelog"</span>)
<span class="keyword">local</span> connection = <span class="global">require</span>(<span class="string">"luasql.exasol.Connection"</span>)
<span class="keyword">local</span> ExaError = <span class="global">require</span>(<span class="string">"ExaError"</span>)
<span class="keyword">local</span> ConnectionProperties = <span class="global">require</span>(<span class="string">"luasql.exasol.ConnectionProperties"</span>)
<span class="keyword">local</span> base64 = <span class="global">require</span>(<span class="string">"luasql.exasol.base64"</span>)

<span class="comment">--- Load a Lua module like `require()` but with fallback to Exasol specific module names.
</span><span class="comment">-- @tparam string modname the name of the module to load
</span><a id="17"></a><span class="comment">-- @return any the loaded module
</span><span class="keyword">local</span> <span class="keyword">function</span> <span class="function-name">require_udf_module</span>(modname)
    <span class="keyword">local</span> success, result = <span class="global">pcall</span>(<span class="global">require</span>, modname)
    <span class="keyword">if</span> success <span class="keyword">then</span>
        <span class="keyword">return</span> result
    <span class="keyword">else</span>
        <span class="keyword">local</span> alternative_modname = <span class="string">"_"</span> .. modname
        log.<span class="global">warn</span>(<span class="string">"Loading module '%s' failed with error '%s', try loading '%s'"</span>, modname, result, alternative_modname)
        <span class="keyword">return</span> <span class="global">require</span>(alternative_modname)
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">local</span> pkey = <span class="function-name">require_udf_module</span>(<span class="string">"openssl.pkey"</span>)
<span class="keyword">local</span> bignum = <span class="function-name">require_udf_module</span>(<span class="string">"openssl.bignum"</span>)

<span class="keyword">local</span> WEBSOCKET_PROTOCOL = <span class="string">"wss"</span>

<span class="keyword">local</span> <span class="keyword">function</span> <span class="function-name">load_exasol_websocket</span>(args)
    <span class="keyword">if</span> args <span class="keyword">and</span> args.exasol_websocket <span class="keyword">then</span>
        <span class="keyword">return</span> args.exasol_websocket
    <span class="keyword">else</span>
        <span class="keyword">return</span> <span class="global">require</span>(<span class="string">"luasql.exasol.ExasolWebsocket"</span>)
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">--- Create a new instance of the Environment class
</span><span class="comment">-- @tparam ?table args allows injecting a websocket module. This is only useful in unit tests and
</span><span class="comment">--   should be `nil` in production code.
</span><a id="45"></a><span class="comment">-- @treturn luasql.exasol.Environment a new instance
</span><span class="keyword">function</span> Environment:<span class="function-name">new</span>(args)
    <span class="keyword">local</span> object = {closed = <span class="keyword">false</span>, connections = {}}
    object.exasol_websocket = <span class="function-name">load_exasol_websocket</span>(args)
    self.__index = self
    <span class="global">setmetatable</span>(object, self)
    <span class="keyword">return</span> object
<span class="keyword">end</span>

<span class="comment">--- Encrypts a password using the given public key modulus and exponent.
</span><span class="comment">-- @tparam string publicKeyModulus the hex encoded modulus of the public key
</span><span class="comment">-- @tparam string publicKeyExponent the hex encoded exponent of the public key
</span><span class="comment">-- @tparam string password the password to encrypt
</span><a id="58"></a><span class="comment">-- @treturn string the encrypted password
</span><span class="keyword">local</span> <span class="keyword">function</span> <span class="function-name">encrypt_password</span>(publicKeyModulus, publicKeyExponent, password)
    <span class="keyword">local</span> rsa = pkey.<span class="function-name">new</span>({<span class="global">type</span> = <span class="string">"RSA"</span>, bits = <span class="number">1024</span>})
    <span class="keyword">local</span> modulus = bignum.<span class="function-name">new</span>(<span class="string">"0x"</span> .. publicKeyModulus)
    <span class="keyword">local</span> exponent = bignum.<span class="function-name">new</span>(<span class="string">"0x"</span> .. publicKeyExponent)
    rsa:<span class="function-name">setParameters</span>({n = modulus, e = exponent})
    <span class="keyword">return</span> base64.<span class="function-name">encode</span>(rsa:<span class="function-name">encrypt</span>(password))
<span class="keyword">end</span>

<span class="comment">--- Login to the database.
</span><span class="comment">-- @tparam luasql.exasol.ExasolWebsocket socket the connection to the database
</span><span class="comment">-- @tparam string username the username
</span><span class="comment">-- @tparam string password the unencrypted password
</span><span class="comment">-- @treturn table|nil connection metadata in case login was successful
</span><a id="72"></a><span class="comment">-- @treturn table|nil `nil` if the operation was successful, otherwise the error that occured
</span><span class="keyword">local</span> <span class="keyword">function</span> <span class="function-name">login</span>(socket, username, password)
    <span class="keyword">local</span> response, err = socket:<span class="function-name">send_login_command</span>()
    <span class="keyword">if</span> err <span class="keyword">then</span>
        <span class="keyword">return</span> <span class="keyword">nil</span>, err
    <span class="keyword">end</span>
    <span class="keyword">local</span> encrypted_password = <span class="function-name">encrypt_password</span>(response.publicKeyModulus, response.publicKeyExponent, password)
    <span class="keyword">return</span> socket:<span class="function-name">send_login_credentials</span>(username, encrypted_password)
<span class="keyword">end</span>

<span class="comment">--- Connect to an Exasol database.
</span><span class="comment">-- @tparam string sourcename hostname and port of the Exasol database, separated with a colon, e.g.:
</span><span class="comment">--   `exasoldb.example.com:8563`. Note that the port is mandatory.
</span><span class="comment">-- @tparam string username the username for logging in to the Exasol database
</span><span class="comment">-- @tparam string password the password for logging in to the Exasol database
</span><span class="comment">-- @tparam ?table properties optional connection properties, see <a href="../classes/luasql.exasol.ConnectionProperties.html#luasql.exasol.connectionproperties.properties">luasql.exasol.ConnectionProperties:properties</a>
</span><span class="comment">-- @treturn luasql.exasol.Connection|nil a new Connection or `nil` if the connection failed
</span><span class="comment">-- @treturn table|nil `nil` if the operation was successful, otherwise the error that occured
</span><a id="90"></a><span class="comment">-- @see ConnectionProperties:create
</span><span class="keyword">function</span> Environment:<span class="function-name">connect</span>(sourcename, username, password, properties)
    <span class="comment">-- [impl -&gt; dsn~luasql-environment-connect~0]
</span>    <span class="keyword">if</span> self.closed <span class="keyword">then</span>
        ExaError:<span class="function-name">new</span>(<span class="string">"E-EDL-21"</span>, <span class="string">"Attempt to connect using an environment that is already closed"</span>):<span class="function-name">raise</span>(<span class="number">3</span>)
    <span class="keyword">end</span>
    <span class="keyword">local</span> connection_properties = ConnectionProperties:<span class="function-name">create</span>(properties)
    <span class="keyword">local</span> socket = self.exasol_websocket.<span class="function-name">connect</span>(WEBSOCKET_PROTOCOL .. <span class="string">"://"</span> .. sourcename, connection_properties)
    <span class="keyword">local</span> response, err = <span class="function-name">login</span>(socket, username, password)
    <span class="keyword">if</span> err <span class="keyword">then</span>
        socket:<span class="function-name">close</span>()
        <span class="keyword">if</span> err[<span class="string">"cause"</span>] == <span class="string">"closed"</span> <span class="keyword">then</span>
            err = ExaError:<span class="function-name">new</span>(<span class="string">"E-EDL-19"</span>,
                                  <span class="string">"Login failed because socket is closed. Probably credentials are wrong: {{error}}"</span>,
                                  {<span class="global">error</span> = <span class="global">tostring</span>(err)})
        <span class="keyword">else</span>
            err = ExaError:<span class="function-name">new</span>(<span class="string">"E-EDL-16"</span>, <span class="string">"Login failed: {{error}}"</span>, {<span class="global">error</span> = <span class="global">tostring</span>(err)})
        <span class="keyword">end</span>
        err:<span class="function-name">add_mitigations</span>(<span class="string">"Check the credentials you provided."</span>)
        <span class="keyword">return</span> <span class="keyword">nil</span>, err
    <span class="keyword">end</span>
    log.<span class="function-name">trace</span>(<span class="string">"Connected to Exasol %s, maximum message size: %s bytes"</span>, response.releaseVersion,
              response.maxDataMessageSize)
    <span class="keyword">local</span> session_id = response.sessionId
    <span class="keyword">local</span> conn = connection:<span class="function-name">create</span>(connection_properties, socket, session_id)
    self.connections[session_id] = conn
    <span class="keyword">return</span> conn, <span class="keyword">nil</span>
<span class="keyword">end</span>

<span class="comment">--- Closes the environment and all connections created using it.
</span><a id="120"></a><span class="comment">-- @treturn boolean `true` if all connections where closed successfully
</span><span class="keyword">function</span> Environment:<span class="function-name">close</span>()
    <span class="comment">-- [impl -&gt; dsn~luasql-environment-close~0]
</span>    <span class="keyword">if</span> self.closed <span class="keyword">then</span>
        log.<span class="global">warn</span>(<span class="global">tostring</span>(ExaError:<span class="function-name">new</span>(<span class="string">"W-EDL-20"</span>, <span class="string">"Attempted to close an already closed environment"</span>)))
        <span class="keyword">return</span> <span class="keyword">false</span>
    <span class="keyword">end</span>

    log.<span class="function-name">trace</span>(<span class="string">"Closing environment: check if all %d connections are closed"</span>, #self.connections)
    <span class="keyword">for</span> _, conn <span class="keyword">in</span> <span class="global">pairs</span>(self.connections) <span class="keyword">do</span>
        <span class="keyword">if</span> <span class="keyword">not</span> conn.closed <span class="keyword">then</span>
            log.<span class="global">warn</span>(<span class="global">tostring</span>(ExaError:<span class="function-name">new</span>(<span class="string">"W-EDL-38"</span>,
                                              <span class="string">"Cannot close environment because not all connections are closed"</span>)))
            <span class="keyword">return</span> <span class="keyword">false</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    self.closed = <span class="keyword">true</span>
    <span class="keyword">return</span> <span class="keyword">true</span>
<span class="keyword">end</span>

<span class="keyword">return</span> Environment</pre>


</div> <!-- id="content" -->
</div> <!-- id="main" -->
<div id="about">
<i>generated by <a href="http://github.com/lunarmodules/LDoc">LDoc 1.5.0</a></i>
<i style="float:right;">Last updated 2023-06-22 12:15:42 </i>
</div> <!-- id="about" -->
</div> <!-- id="container" -->
</body>
</html>
